{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
PRODUCT PRICE (with Locksmith trade pricing)
----------------------------------------------------------------------------------------------------------------------

* Shows discounted price only when:
  - product.template_suffix == 'trade'
  - locksmith_access_granted == true
  - product.metafields.custom.trade_price > 0
* Otherwise, falls back to regular price display.
{%- endcomment -%}

{% capture var %}{% render 'locksmith-variables', variable: 'access_granted', scope: 'subject', subject: product %}{% endcapture %}
{% if var == 'true' %}{% assign locksmith_access_granted = true %}{% else %}{% assign locksmith_access_granted = false %}{% endif %}

{%- liquid
  case context
    when 'card' or 'line_item'
      assign base_text_class = ''
      if settings.product_card_text_font == 'heading'
        assign base_text_class = 'h6 '
      endif
      assign regular_price_classes = base_text_class | append: 'text-subdued'
      assign on_sale_price_classes = base_text_class | append: 'text-on-sale'
      assign compare_at_price_classes = base_text_class | append: 'text-subdued line-through'
      assign unit_price_classes = base_text_class | append: 'text-subdued'
    when 'product'
      assign regular_price_classes = base_text_class | append: 'h4 text-subdued'
      assign on_sale_price_classes = base_text_class | append: 'h4 text-on-sale'
      assign compare_at_price_classes = base_text_class | append: 'h5 text-subdued line-through'
      assign unit_price_classes = base_text_class | append: 'h6 text-subdued'
  endcase
-%}

{% if product.template_suffix == 'trade' and locksmith_access_granted %}
  {%- assign trade_discount = product.metafields.custom.trade_price | default: 0 | plus: 0 -%}
  {%- if trade_discount < 0 -%}{%- assign trade_discount = 0 -%}{%- endif -%}
  {%- if trade_discount > 100 -%}{%- assign trade_discount = 100 -%}{%- endif -%}

  <price-list class="price-list {% if context == 'product' %}price-list--product{% endif %}">
    {%- if variant != blank -%}
      {%- assign base_price = variant.price -%}
      {%- assign discount_amount = base_price | times: trade_discount | divided_by: 100 -%}
      {%- assign discounted_price = base_price | minus: discount_amount -%}
      {%- assign show_compare = discounted_price < base_price and trade_discount > 0 -%}

      <sale-price class="{% if show_compare %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}">
        {%- if settings.currency_code_enabled -%}
          {{ discounted_price | money_with_currency }}
        {%- else -%}
          {{ discounted_price | money }}
        {%- endif -%}
      </sale-price>

      {%- if show_compare -%}
        <compare-at-price class="{{ compare_at_price_classes }}">
          {%- if settings.currency_code_enabled -%}
            {{ base_price | money_with_currency }}
          {%- else -%}
            {{ base_price | money }}
          {%- endif -%}
        </compare-at-price>
      {%- endif -%}

    {%- elsif line_item != blank -%}
      {%- assign base_price = line_item.final_price -%}
      {%- assign discount_amount = base_price | times: trade_discount | divided_by: 100 -%}
      {%- assign discounted_price = base_price | minus: discount_amount -%}
      {%- assign show_compare = discounted_price < base_price and trade_discount > 0 -%}

      <sale-price class="{% if show_compare %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}">
        {%- if settings.currency_code_enabled -%}
          {{ discounted_price | money_with_currency }}
        {%- else -%}
          {{ discounted_price | money }}
        {%- endif -%}
      </sale-price>

      {%- if show_compare -%}
        <compare-at-price class="{{ compare_at_price_classes }}">
          {%- if settings.currency_code_enabled -%}
            {{ base_price | money_with_currency }}
          {%- else -%}
            {{ base_price | money }}
          {%- endif -%}
        </compare-at-price>
      {%- endif -%}

    {%- elsif product != blank -%}
      {%- liquid
        if product.price_varies and settings.product_price_strategy != 'from_price'
          assign card_variant = product.variants | sort: 'price' | last | default: product.selected_or_first_available_variant
        else
          assign card_variant = product.variants | sort: 'price' | first | default: product.selected_or_first_available_variant
        endif
        assign base_price = card_variant.price
        assign discount_amount = base_price | times: trade_discount | divided_by: 100
        assign discounted_price = base_price | minus: discount_amount
        assign show_compare = discounted_price < base_price and trade_discount > 0
      -%}

      <sale-price class="{% if show_compare %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}">
        {%- if settings.currency_code_enabled -%}
          {{ discounted_price | money_with_currency }}
        {%- else -%}
          {{ discounted_price | money }}
        {%- endif -%}
      </sale-price>

      {%- if show_compare -%}
        <compare-at-price class="{{ compare_at_price_classes }}">
          {%- if settings.currency_code_enabled -%}
            {{ base_price | money_with_currency }}
          {%- else -%}
            {{ base_price | money }}
          {%- endif -%}
        </compare-at-price>
      {%- endif -%}
    {%- endif -%}
  </price-list>

{% else %}
  {#-- FALLBACK: your original price rendering + register link --#}

  <price-list class="price-list {% if context == 'product' %}price-list--product{% endif %}">
    {%- if variant != blank -%}
      <sale-price class="{% if variant.compare_at_price > variant.price %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}">
        {%- if settings.currency_code_enabled -%}
          {{- variant.price | money_with_currency -}}
        {%- else -%}
          {{- variant.price | money -}}
        {%- endif -%}
      </sale-price>
      {%- if variant.compare_at_price > variant.price -%}
        <compare-at-price class="{{ compare_at_price_classes }}">
          {%- if settings.currency_code_enabled -%}
            {{- variant.compare_at_price | money_with_currency -}}
          {%- else -%}
            {{- variant.compare_at_price | money -}}
          {%- endif -%}
        </compare-at-price>
      {%- endif -%}

    {%- elsif line_item != blank -%}
      <sale-price class="{% if line_item.original_price > line_item.final_price %}{{ on_sale_price_classes }}{% else %}{{ regular_price_classes }}{% endif %}">
        {%- if settings.currency_code_enabled -%}
          {{- line_item.final_price | money_with_currency -}}
        {%- else -%}
          {{- line_item.final_price | money -}}
        {%- endif -%}
      </sale-price>
      {%- if line_item.original_price > line_item.final_price -%}
        <compare-at-price class="{{ compare_at_price_classes }}">
          {%- if settings.currency_code_enabled -%}
            {{- line_item.original_price | money_with_currency -}}
          {%- else -%}
            {{- line_item.original_price | money -}}
          {%- endif -%}
        </compare-at-price>
      {%- endif -%}

    {%- elsif product != blank -%}
      {%- liquid
        if product.price_varies and settings.product_price_strategy != 'from_price'
          assign variant = product.variants | sort: 'price' | last | default: product.selected_or_first_available_variant
        else
          assign variant = product.variants | sort: 'price' | first | default: product.selected_or_first_available_variant
        endif
        if settings.currency_code_enabled
          assign variant_price = variant.price | money_with_currency
          assign variant_compare_at_price = variant.compare_at_price | money_with_currency
        else
          assign variant_price = variant.price | money
          assign variant_compare_at_price = variant.compare_at_price | money
        endif
      -%}
      <sale-price class="{{ on_sale_price_classes }}">
        {%- if settings.currency_code_enabled -%}
          {{ variant_price }}
        {%- else -%}
          {{ variant_price }}
        {%- endif -%}
      </sale-price>
      {%- if variant.price < variant.compare_at_price -%}
        <compare-at-price class="{{ compare_at_price_classes }}">
          {{ variant_compare_at_price }}
        </compare-at-price>
      {%- endif -%}

    {%- else -%}
      <sale-price class="{{ regular_price_classes }}">
        {%- if settings.currency_code_enabled -%}
          {{ 4999 | money_with_currency }}
        {%- else -%}
          {{ 4999 | money }}
        {%- endif -%}
      </sale-price>
    {%- endif -%}
  </price-list>
  <br>
  <a class="button" href="https://realmoutdoor.com/pages/register" style="width:50%">REGISTER TO ACCESS PRICING</a>
{% endif %}