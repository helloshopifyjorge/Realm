{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
TRADE PRICE SNIPPET
----------------------------------------------------------------------------------------------------------------------

Displays trade price = variant price minus % discount defined in metafields.

Metafields required:
  • Variant → custom.trade_percent  (Number: Decimal or Integer, 0–100)
  • (Optional fallback) Product → custom.trade_percent

If no metafield or 0% is set, falls back to normal price rendering.
{%- endcomment -%}

{%- liquid
  case context
    when 'card' or 'line_item'
      assign base_text_class = ''
      if settings.product_card_text_font == 'heading'
        assign base_text_class = 'h6 '
      endif
      assign regular_price_classes = base_text_class | append: 'text-subdued'
      assign on_sale_price_classes = base_text_class | append: 'text-on-sale'
      assign compare_at_price_classes = base_text_class | append: 'text-subdued line-through'
      assign unit_price_classes = base_text_class | append: 'text-subdued'
    when 'product'
      assign regular_price_classes = base_text_class | append: 'h4 text-subdued'
      assign on_sale_price_classes = base_text_class | append: 'h4 text-on-sale'
      assign compare_at_price_classes = base_text_class | append: 'h5 text-subdued line-through'
      assign unit_price_classes = base_text_class | append: 'h6 text-subdued'
  endcase

  assign current_variant = variant | default: product.selected_or_first_available_variant

  # Read % from variant first, then product
  assign v_pct = current_variant.metafields.custom.trade_percent
  assign p_pct = product.metafields.custom.trade_percent
  assign trade_percent = v_pct
  if trade_percent == blank or trade_percent == 0
    assign trade_percent = p_pct
  endif

  # Normalize and clamp
  assign trade_percent = trade_percent | default: 0 | plus: 0
  if trade_percent < 0
    assign trade_percent = 0
  endif
  if trade_percent > 100
    assign trade_percent = 100
  endif

  assign base_price = current_variant.price
-%}

{%- if trade_percent > 0 and base_price > 0 -%}
  {%- assign discount_amount = base_price | times: trade_percent | divided_by: 100 -%}
  {%- assign trade_price = base_price | minus: discount_amount -%}

  <price-list class="price-list {% if context == 'product' %}price-list--product{% endif %}">
    <sale-price class="{{ on_sale_price_classes }}">
      <span class="sr-only">{{ 'product.price.sale_price' | t }}</span>
      {%- if settings.currency_code_enabled -%}
        {{ trade_price | money_with_currency }}
      {%- else -%}
        {{ trade_price | money }}
      {%- endif -%}
    </sale-price>

    <compare-at-price class="{{ compare_at_price_classes }}">
      <span class="sr-only">{{ 'product.price.regular_price' | t }}</span>
      {%- if settings.currency_code_enabled -%}
        {{ base_price | money_with_currency }}
      {%- else -%}
        {{ base_price | money }}
      {%- endif -%}
    </compare-at-price>

    {%- unless hide_unit_price -%}
      {%- assign unit_price_item = current_variant -%}
      {%- if unit_price_item.unit_price -%}
        <unit-price class="{{ unit_price_classes }}">
          {%- assign m = unit_price_item.unit_price_measurement -%}
          {%- if m.reference_value != 1 -%}{%- assign reference_value = m.reference_value -%}{%- endif -%}
          ({{ unit_price_item.unit_price | money }}/{{ reference_value }}{{ m.reference_unit }})
        </unit-price>
      {%- endif -%}
    {%- endunless -%}
  </price-list>

{%- else -%}
  {# Fall back to your normal price list snippet #}
  {%- render 'price-list', product: product, variant: current_variant, line_item: line_item, hide_unit_price: hide_unit_price, context: context -%}
{%- endif -%}